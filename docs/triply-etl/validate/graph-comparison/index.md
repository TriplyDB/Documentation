
[TOC]

# Graph Comparison

Graph comparison is an approach for validating that the data produced by your TriplyETL pipeline is correct.

For a limited set of key records, the linked data that is generated by the TriplyETL pipeline is compared to graphs that were created by hand.  This comparison must follow certain rules that are laid out in the RDF standards.



## Prerequisites

Graph comparison can be used when the following preconditions are met:

1. You have identified a number of key records that are representative of your dataset.
2. For these identified key records, you have created RDF files that contain the linked data that should be generated by your TriplyETL pipeline.
3. You have added these RDF files to your TriplyETL configuration, e.g. by storing them in a special subdirectory next to your `*.ts` files.

The function for comparing graphs can be imported from the generic TriplyETL library:

```ts
import { compareGraphs } from '@triplyetl/etl/generic'
```



## A complete example

We use the following full TriplyETL script to explain the validation feature.  Do not be afraid by the length of the script; we will go through each part step-by-step.

```ts
import { compareGraphs, declarePrefix, Etl, fromJson,
         Source } from '@triplyetl/etl/generic'
import { iri, pairs } from '@triplyetl/etl/ratt'
import { qudt, rdf, unit } from '@triplyetl/etl/vocab'

const base = declarePrefix('https://example.com/')
const prefix = {
  graph: declarePrefix(base('id/graph/')),
  skolem: declarePrefix(base('.well-known/genid/')),
}

export default async function (): Promise<Etl> {
  const etl = new Etl({ defaultGraph: prefix.graph('instances') })
  etl.use(
    fromJson([{ id: '1', height: 15 }]),
    pairs(iri(prefix.skolem, 'id'),
      [qudt.unit, unit.CentiM],
      [rdf.value, 'height'],
    ),
    compareGraphs(Source.file('product-1.trig')),
  )
  return etl
}
```


### Step 1: Identify representative records

Select a limited number of records from your data sources that together are representative for the full data source systems.

This often includes typical records where the expected data items are included, as well as atypical records that are 'outliers'.

There must be reasonable confidence that a TriplyETL pipeline that produces the correct results for these selected records is likely to produce correct results for all records.


### Step 2: Manually create linked data

Create an RDF file for every representative record.  The file must contain the linked data that should be generated for that specific record.  It is probably best to use the TriG format for this, but all RDF formats are supported.

For our example, we create a file called `product-1.trig` with the following content:

```turtle
prefix graph: <https://example.com/id/graph/>
prefix qudt: <http://qudt.org/schema/qudt/>
prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
prefix unit: <http://qudt.org/vocab/unit/>

graph:instances {
  []
    qudt:unit unit:CentiM;
    rdf:value 15.
}
```


### Step 3: Create the ETL

Write the TriplyETL configuration.  In our example we start with the prefix declarations:

```ts
const base = declarePrefix('https://example.com/')
const prefix = {
  graph: declarePrefix(base('id/graph/')),
  skolem: declarePrefix(base('.well-known/genid/')),
}
```

We use the following extractor:

```ts
fromJson([{ id: '1', height: 15 }]),
```

And we use the following assertions:

```ts
pairs(iri(prefix.skolem, 'id'),
  [qudt.unit, unit.CentiM],
  [rdf.value, 'height'],
),
```

### Step 4. Perform graph comparison

In our example, we only generate linked data for one record, so we can trivially compare the results for that one record with the manually created RDF that is stored in the local file:

```ts
compareGraphs(Source.file('product-1.trig')),
```

In more complex pipleines you may need to determine the local file based on the data.  For example, check whether the value for key `id` in the record corresponds to a local file called `product-ID.trig`.

If the generated graph differs in any meaningful way from the RDF stored in the local file, and error is emitted and the TriplyETL pipeline is interrupted.
